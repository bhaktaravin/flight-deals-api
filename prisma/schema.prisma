generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Route {
  id          String   @id @default(uuid())
  origin      String
  destination String
  createdAt   DateTime @default(now())

  searches Search[]
}

model Search {
  id        String   @id @default(uuid())
  departAt  DateTime
  createdAt DateTime @default(now())

  route   Route  @relation(fields: [routeId], references: [id])
  routeId String
}

model FlightSearch {
  id          String         @id @default(uuid())
  origin      String
  destination String
  departDate  DateTime
  passengers  Int
  createdAt   DateTime       @default(now())
  results     FlightResult[]
}

model FlightResult {
  id              String  @id @default(uuid())
  provider        String
  price           Decimal @db.Decimal(10, 2)
  currency        String
  durationMinutes Int
  stops           Int

  searchId String
  search   FlightSearch @relation(fields: [searchId], references: [id])

  segments FlightSegment[]
}

model FlightSegment {
  id           String   @id @default(uuid())
  from         String
  to           String
  departAt     DateTime
  arriveAt     DateTime
  carrier      String
  flightNumber String

  resultId String
  result   FlightResult @relation(fields: [resultId], references: [id])
}

model PriceAlert {
  id          String   @id @default(uuid())
  origin      String
  destination String
  departDate  DateTime
  passengers  Int            @default(1)
  targetPrice Decimal        @db.Decimal(10, 2)
  currency    String         @default("USD")
  email       String?
  webhook     String?
  status      AlertStatus    @default(ACTIVE)
  lastChecked DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  notifications PriceAlertNotification[]

  @@index([status, lastChecked])
  @@index([origin, destination, departDate])
}

model PriceAlertNotification {
  id          String   @id @default(uuid())
  alertId     String
  alert       PriceAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)
  currentPrice Decimal  @db.Decimal(10, 2)
  message     String
  sentAt      DateTime @default(now())
}

enum AlertStatus {
  ACTIVE
  PAUSED
  EXPIRED
  TRIGGERED
}
